<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二次元壁纸 - 发现你的专属壁纸</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS 变量定义，方便统一修改主题色 */
        :root {
            --theme-color: #7e57c2;
            --theme-color-dark: #673ab7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'M PLUS Rounded 1c', 'Segoe UI', 'Microsoft YaHei', sans-serif; /* 使用新的二次元风格字体 */
        }

        /* 自定义文本选中颜色 */
        ::selection {
            background: var(--theme-color);
            color: #fff;
        }

        body {
            background: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('https://image.loliacg.top/qing.jpg'); /* 保留原始背景图 */
            background-size: cover;
            background-attachment: fixed;
            color: #555; /* 调整默认字体颜色，更柔和 */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 头部样式 */
        header {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            justify-content: center; /* 居中对齐 */
            align-items: center;
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--theme-color); /* 使用主题色 */
            text-decoration: none;
            display: flex;
            align-items: center;
            text-shadow: 0 0 5px rgba(126, 87, 194, 0.3); /* 给 logo 加一点微光 */
        }
        .logo i {
            margin-right: 10px;
        }
        
        /* 瀑布流容器样式 */
        .waterfall-container {
            flex-grow: 1; /* 占据剩余空间 */
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            column-count: 5;
            column-gap: 15px;
        }
        @media (max-width: 1200px) {
            .waterfall-container {
                column-count: 4;
            }
        }
        @media (max-width: 900px) {
            .waterfall-container {
                column-count: 3;
            }
        }
        @media (max-width: 600px) {
            .waterfall-container {
                column-count: 2;
            }
        }
        
        /* 壁纸项样式 - 更精致的悬停效果 */
        .wallpaper-item {
            break-inside: avoid;
            margin-bottom: 15px;
            border-radius: 12px; /* 圆角更圆润一些 */
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            opacity: 0; /* 初始透明 */
            animation: fadeIn 0.5s ease forwards; /* 添加淡入动画 */
        }
        .wallpaper-item:hover {
            transform: translateY(-8px); /* 上移多一点 */
            box-shadow: 0 8px 25px rgba(126, 87, 194, 0.2); /* 关键：使用主题色的发光阴影 */
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .wallpaper-img {
            width: 100%;
            display: block;
        }
        .wallpaper-info {
            padding: 12px;
        }
        .wallpaper-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .action-btn {
            flex: 1;
            padding: 6px 0;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        .action-btn:hover {
            color: var(--theme-color);
        }
        .action-btn i {
            margin-right: 5px;
        }
        
        /* 加载更多按钮 - 更有活力的样式 */
        .load-more-container {
            text-align: center;
            padding: 30px 0;
        }
        .load-more-btn {
            padding: 12px 35px;
            background: linear-gradient(45deg, var(--theme-color), #a87ee3); /* 添加渐变 */
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(126, 87, 194, 0.3);
            transition: all 0.3s ease;
        }
        .load-more-btn:hover {
            transform: translateY(-3px) scale(1.05); /* 悬停时放大并上移 */
            box-shadow: 0 6px 20px rgba(126, 87, 194, 0.4);
        }
        
        /* 预览模态框 - 增加弹出动画 */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease;
        }
        .preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            animation: modalScaleIn 0.3s ease;
        }
        @keyframes modalFadeIn {
            from { background-color: rgba(0, 0, 0, 0); }
            to { background-color: rgba(0, 0, 0, 0.9); }
        }
        @keyframes modalScaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .preview-img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
        }
        .preview-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        .preview-actions {
            position: absolute;
            bottom: -60px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .preview-btn {
            padding: 10px 20px;
            background-color: var(--theme-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .preview-btn:hover {
            background-color: var(--theme-color-dark);
        }
        
        /* 盲盒功能 - 增加呼吸/浮动动画 */
        .blind-box {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--theme-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, background-color 0.3s;
            z-index: 99;
            animation: float 3s ease-in-out infinite; /* 应用动画 */
        }
        .blind-box:hover {
            transform: scale(1.1);
            background-color: var(--theme-color-dark);
            animation-play-state: paused; /* 悬停时暂停动画 */
        }
        @keyframes float {
            0% {
                transform: translateY(0px);
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
            50% {
                transform: translateY(-10px);
                box-shadow: 0 14px 20px rgba(126, 87, 194, 0.3);
            }
            100% {
                transform: translateY(0px);
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
        }
        
        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(126, 87, 194, 0.3); /* 使用主题色 */
            border-radius: 50%;
            border-top-color: var(--theme-color); /* 使用主题色 */
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 页脚 */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: auto; /* 保持在页面底部 */
            color: #fff;
            background-color: rgba(45, 55, 72, 0.8);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="#" class="logo">
                <i class="fas fa-image"></i>
                二次元壁纸
            </a>
        </div>
    </header>
    <div class="waterfall-container" id="waterfall-container">
    </div>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>
    <div class="load-more-container">
        <button class="load-more-btn" id="load-more">加载更多</button>
    </div>
    <div class="blind-box" id="blind-box" title="壁纸盲盒">
        <i class="fas fa-gift"></i>
    </div>
    <div class="preview-modal" id="preview-modal">
        <div class="preview-content">
            <span class="preview-close" id="preview-close">&times;</span>
            <img src="" alt="" class="preview-img" id="preview-img">
            <div class="preview-actions">
                <button class="preview-btn" id="download-btn">
                    <i class="fas fa-download"></i> 下载壁纸
                </button>
                <button class="preview-btn" id="like-btn">
                    <i class="fas fa-heart"></i> 收藏
                </button>
                <button class="preview-btn" id="share-btn">
                    <i class="fas fa-share-alt"></i> 分享
                </button>
            </div>
        </div>
    </div>
    <footer>
        <p>&copy; 2023 二次元壁纸. All Rights Reserved.</p>
    </footer>

    <script>
        // 你的 API 接口地址
        const API_ENDPOINT = 'https://black-haze-d51d.sarazayen29.workers.dev/';
        
        // 全局变量
        let allImages = [];
        let isLoading = false;
        let hasMore = true;
        let nextCursor = null;

        // 绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            fetchWallpapers();
        });

        function setupEventListeners() {
            // 加载更多按钮
            document.getElementById('load-more').addEventListener('click', function() {
                fetchWallpapers(nextCursor);
            });

            // 盲盒按钮
            document.getElementById('blind-box').addEventListener('click', function() {
                showRandomWallpaper();
            });

            // 预览模态框关闭按钮
            document.getElementById('preview-close').addEventListener('click', function() {
                document.getElementById('preview-modal').style.display = 'none';
            });

            // 点击模态框外部关闭
            document.getElementById('preview-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // 绑定预览模态框下载按钮事件
            document.getElementById('download-btn').addEventListener('click', downloadImage);
        }

        // 从 API 获取壁纸数据
        async function fetchWallpapers(cursor = null) {
            if (isLoading || !hasMore) return;

            isLoading = true;
            const loading = document.getElementById('loading');
            const loadMoreBtn = document.getElementById('load-more');
            loading.style.display = 'block';
            loadMoreBtn.style.display = 'none';

            let apiUrl = API_ENDPOINT + '?limit=30'; // 每次请求 30 张
            if (cursor) {
                apiUrl += '&cursor=' + cursor;
            }

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // 存储数据
                allImages = allImages.concat(data.images);
                nextCursor = data.nextCursor;
                hasMore = data.hasMore;

                // 渲染数据
                await renderWallpapers(data.images);

            } catch (error) {
                console.error("无法获取壁纸数据:", error);
                document.getElementById('waterfall-container').innerHTML = '<p style="text-align: center; color: red;">加载壁纸失败，请检查API地址。</p>';
            } finally {
                // 隐藏加载动画，显示加载更多按钮
                loading.style.display = 'none';
                if (hasMore) {
                    loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
                isLoading = false;
            }
        }

        // 渲染壁纸到页面 - [修改] 增加交错动画效果
        async function renderWallpapers(images) {
            const container = document.getElementById('waterfall-container');

            // 预加载所有图片，以确保瀑布流布局正确
            const imagePromises = images.map(image => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve();
                    img.onerror = () => resolve(); // 即使失败也继续
                    img.src = image.thumbnailUrl;
                });
            });

            await Promise.all(imagePromises);

            const fragment = document.createDocumentFragment(); // 使用文档片段提高性能
            images.forEach((image, index) => {
                const imageElement = createWallpaperElement(image);
                // 为每个新元素增加一点延迟，形成交错的淡入效果
                imageElement.style.animationDelay = `${index * 0.05}s`;
                fragment.appendChild(imageElement);
            });
            container.appendChild(fragment); // 一次性添加到DOM
        }

        // 创建壁纸元素
        function createWallpaperElement(image) {
            const item = document.createElement('div');
            item.className = 'wallpaper-item';
            
            // 移除了 <div class="wallpaper-title">${image.name}</div>
            item.innerHTML = `
                <img src="${image.thumbnailUrl}" alt="${image.name}" class="wallpaper-img">
                <div class="wallpaper-info">
                    <div class="wallpaper-actions">
                        <button class="action-btn download-btn"><i class="fas fa-download"></i> 下载</button>
                        <button class="action-btn preview-btn"><i class="fas fa-expand"></i> 预览</button>
                    </div>
                </div>
            `;

            // 绑定下载和预览按钮事件
            item.querySelector('.download-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                downloadImage(e, image.url, image.name);
            });

            item.querySelector('.preview-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                showPreview(image.url, image.name);
            });

            // 绑定整个卡片的点击事件
            item.addEventListener('click', function() {
                showPreview(image.url, image.name);
            });

            return item;
        }

        // 显示预览
        function showPreview(imageUrl, title) {
            const modal = document.getElementById('preview-modal');
            const previewImg = document.getElementById('preview-img');
            
            previewImg.src = imageUrl;
            previewImg.alt = title;

            // 更新预览模态框的下载按钮
            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.dataset.imageUrl = imageUrl;
            downloadBtn.dataset.imageName = title;

            modal.style.display = 'flex';
        }
        
        // 下载图片函数 - [修改] 不再跳转，直接下载
        async function downloadImage(e, imageUrl = null, imageName = null) {
            e.stopPropagation();
            
            const url = imageUrl || e.currentTarget.dataset.imageUrl;
            const name = imageName || e.currentTarget.dataset.imageName || 'wallpaper.jpg';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
                
                console.log('下载成功:', name);
            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败，请稍后重试。');
            }
        }

        // 显示随机壁纸（盲盒功能）
        function showRandomWallpaper() {
            if (allImages.length === 0) {
                alert("图片列表为空，请先加载数据！");
                return;
            }
            const randomIndex = Math.floor(Math.random() * allImages.length);
            const randomImage = allImages[randomIndex];
            showPreview(randomImage.url, randomImage.name);
            
            const blindBox = document.getElementById('blind-box');
            blindBox.style.transform = 'scale(1.2) rotate(10deg)';
            setTimeout(() => {
                blindBox.style.transform = 'scale(1) rotate(0deg)';
            }, 300);
        }
    </script>
</body>
</html>